# Copyright 2025 ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

name: docker-build-push
description: Build and push a Docker target to GHCR
inputs:
  target:
    description: "Dockerfile target to build"
    required: true
  tags:
    description: "Docker image tags"
    required: true
  token:
    description: "Token used to authenticate to GHCR"
    required: true

runs:
  using: "composite"
  steps:
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        docker-images: false

    - uses: docker/setup-buildx-action@v3

    - name: GHCR Log-in
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.token }}

    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        context: .
        file: util/container/Dockerfile
        target: ${{ inputs.target }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        push: true
        tags: ${{ inputs.tags }}
