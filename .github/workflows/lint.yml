# Copyright 2023 ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

# Run all lint checks
name: lint
on: [push, pull_request]

jobs:

  ################
  # Verible Lint #
  ################
  verible-lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: chipsalliance/verible-linter-action@main
      with:
        paths: |
          ./hw
        github_token: ${{ secrets.GITHUB_TOKEN }}
        fail_on_error: true
        reviewdog_reporter: github-check
        extra_args: "--waiver_files util/verible.waiver"

  #####################
  # Vendor Up-to-Date #
  #####################
  bender-vendor-up-to-date:
    runs-on: ubuntu-latest
    steps:
      - name: Check bender vendor up-to-date
        uses: pulp-platform/pulp-actions/bender-vendor-up-to-date@v2

  ######################
  # Opcodes Up-to-Date #
  ######################
  check-opcodes:
    name: Check Opcodes Up-to-Date
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - name: Update opcodes and diff
        run: |
          ./util/generate-opcodes.sh
      - name: Diff porcelain
        uses: mmontes11/diff-porcelain@v0.0.1
        with:
          message: Found differences, please update all opcode

  ########################
  # Check Doc up-to-date #
  ########################
  check-doc:
    name: Documentation Up-to-Date
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '12'
      - run: npm install -g @adobe/jsonschema2md@v5.0.1
      - name: Re-generate documentation and diff
        run: |
          cd docs/ && rm -r schema-doc && jsonschema2md -d schema/ --out schema-doc -x schema-doc -n
      - name: Diff porcelain
        uses: mmontes11/diff-porcelain@v0.0.1
        with:
          message: Found stale documentation, please re-generate schema doc.

  #################
  # Check License #
  #################
  license-lint:
    name: Check License headers
    runs-on: ubuntu-latest
    steps:
      - name: Check License
        uses: pulp-platform/pulp-actions/lint-license@patch/license-checker
        with:
          patches: 0001-Allow-hash-comments-in-assembly.patch
        # We cover ETH Zurich and lowRISC licenses and Apache 2.0 (mostly for SW)
        # and Solderpad for the hardware.
          license: |
            Copyright (\d{4}(-\d{4})?\s)?(ETH Zurich and University of Bologna|lowRISC contributors).
            (Solderpad Hardware License, Version 0.51|Licensed under the Apache License, Version 2.0), see LICENSE for details.
            SPDX-License-Identifier: (SHL-0.51|Apache-2.0)
          match_regex: true

  ##################
  # Lint YML Files #
  ##################
  yaml-lint:
    name: Lint YAML Sources
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: yaml-lint
        uses: ibiqlik/action-yamllint@v3

  ########################
  # Check Python Sources #
  ########################
  python-lint:
    runs-on: ubuntu-latest
    name: Lint Python Sources
    steps:
      - name: Check out source repository
        uses: actions/checkout@v3
      - name: Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: flake8 Lint
        uses: py-actions/flake8@v2

  ######################
  # Clang-Format Check #
  ######################
  # Check C/C++ files for correct formatting.
  clangfmt:
    name: Lint C/C++ Sources
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: DoozyX/clang-format-lint-action@v0.16.2
        with:
          clangFormatVersion: 10

  ######################
  # Lint Editor Config #
  ######################
  # Detect trailing whitespaces, missing new lines and wrong file encodings.
  editorconfig-lint:
    name: Lint Editorconfig
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: editorconfig-checker/action-editorconfig-checker@main
      - run: editorconfig-checker
